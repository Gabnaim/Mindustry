Initialize:
	set status "INITIALIZE"
	set unitType @poly
	set miningDistance 7
	set maxSearchDistance 40
	set alwaysSlow true

GetSorter: 
	set sorter sorter1
	jump GetSorter equal sorter null
	
GetStartInfo:
	ubind unitType
	jump GetStartInfo equal @unit null
	sensor flag @unit @flag
	sensor range @unit @range
	jump GetStartInfo notEqual flag 0

	op mul nearDistance miningDistance 2
	set maxDistance maxSearchDistance

	set originX @thisx
	set originY @thisy
	set x originX
	set y originY

	set status "START"
	ser error " "

Start:
	print status
	print " "
	print error
	printflush message1
	set debugSorter sorter2

ReadOre:
	sensor minedOre sorter @config
	jump Reset notEqual minedOre lastOre
	jump Reset equal minedOre null
	sensor id minedOre @id
	jump CannotMine greaterThan id 9
	jump Start equal status "ERROR"
	jump Start equal status "FOUND"
	
QuickSearch:
	set status "QUICKSEARCH"
GoToDrop:
	ucontrol within originX originY 1 isNearDrop
	jump LocateOre equal isNearDrop true
	ucontrol approach originX originY 1
	jump GoToDrop always

	LocateOre:
		ucontrol getBlock @thisx @thisy type building procFloor
		ulocate ore core true minedOre oreX oreY oreFound oreMine
		set locateX oreX
		set locateY oreY
		jump NoOre equal oreFound false
		jump GetMinedFloor equal alwaysSlow true

	CheckDistance:
		op sub diffX oreX originX
		op sub diffY oreY originY
		op len distance diffX diffY
		jump FoundOre lessThanEq distance nearDistance
		# if too far, we won't get much better results with a manual search
		jump FoundOre greaterThanEq distance maxSearchDistance
		op min maxDistance maxSearchDistance distance

GetMinedFloor:
	set status "GETMINEDFLOOR"
	op mul offset id 2
	op add offset offset 1
	op add jump @counter offset
	set @counter jump

	set minedFloor @ore-copper
	jump SlowSearch always
	set minedFloor @ore-lead
	jump SlowSearch always
	set error "Cannot mine ore"
	jump Error always
	set error "Cannot mine ore"
	jump Error always
	set minedFloor @sand-floor
	jump SlowSearch always
	set minedFloor @ore-coal
	jump SlowSearch always
	set minedFloor @ore-titanium
	jump SlowSearch always
	set error "Cannot mine ore"
	jump Error always
	set minedFloor @ore-scrap
	jump SlowSearch always

	CannotMine:
		set error "Cannot mine ore"
		jump Error always

# Searches in rings (really squares) outward. 
# Searches each side from middle to the corners.
# search order: 0: bottom, 1: top, 2: left, 3: right
SlowSearch:
	set startTime @time
	set status "SLOWSEARCH"
	set ring 1
	RingLoop:
		SearchSquare:
		ReadOre:
			sensor minedOre sorter @config
			jump Reset notEqual minedOre lastOre

			SelectSide:
				set step 0
				jump Bottom equal side 0
				jump Top equal side 1
				jump Left equal side 2
				jump Right equal side 3

				set error "Square should have four sides"
				set errorData side
				jump Error always

			Bottom:
				set x originX
				op sub y originY ring
				jump SearchHorizontalSide always

			Top:
				set x originX
				op add y originY ring
				jump SearchHorizontalSide always

			Left:
				op sub x originX ring
				set y originY
				jump SearchVerticalSide always

			Right:
				op add x originX ring
				set y originY
				jump SearchVerticalSide always

			SearchHorizontalSide:
				HSideLoop:
					jump NextSide greaterThan step ring

					op add x originX step 
					op add searchSideReturn @counter 1
					jump SearchSide always

					op sub x originX step 
					op add searchSideReturn @counter 1
					jump SearchSide always

					op add step step 1
					jump HSideLoop always

			SearchVerticalSide:
				VSideLoop:
					jump NextSide greaterThan step ring

					op add y originY step 
					op add searchSideReturn @counter 1
					jump SearchSide always

					op sub y originY step 
					op add searchSideReturn @counter 1
					jump SearchSide always

					op add step step 1
					jump VSideLoop always
			
			NextSide:
				op add side side 1
				jump SearchSquare lessThan side 4

	NextRing:
		op add ring ring 1
		set side 0
		jump RingLoop lessThan ring maxDistance
	
	jump FoundOre equal oreFound true

NoOre:
	set error "No ore found"

Error:
	set status "ERROR"
	jump Start always

FoundSlow:
	set oreX x
	set oreY y

FoundOre:
	ucontrol move oreX oreY
	set status "FOUND"
	set endTime @time
	op sub elapsed endTime startTime
	jump Start always

Reset:
	set lastOre minedOre
	set oreFound false
	set status "IDLE"
	jump Start always

SearchSide:
	CheckBlock:
		ucontrol getBlock x y type building floor
		jump CheckBlockEnd notEqual type @air
		jump FoundSlow equal minedFloor floor
		jump CheckBlockEnd notEqual minedOre @sand
		CheckSand:
			jump FoundSlow equal floor @darksand
		CheckBlockEnd:

	SearchSideEnd:
		set @counter searchSideReturn



