set name "Ground Feeder"

Initialize:
	set unitType @flare
	op shl procId @thisx 10
	op add procId procId @thisy
	set maxTick 600 #release mule after 10 seconds idle
	set sourceMin 500
	set dropRange 7

	GetLinks:
		set factory factory1
		jump GetLinks equal factory null
	
	sensor factoryX factory @x
	sensor factoryY factory @y
	
	GetStartInfo:
		ubind unitType
		jump GetStartInfo equal @unit null
		sensor cap @unit @itemCapacity
		sensor range @unit @range
		ulocate building core false 0 sourceX sourceY sourceFound source

Start:
	printflush message1
###########################################	
CheckFactory:
###########################################
	sensor buildType factory @config
	jump CheckDagger equal buildType @dagger
	jump CheckCrawler equal buildType @crawler
	jump CheckNova equal buildType @nova
	jump Start always
	
CheckDagger:	
	set stockLevel 20
	sensor facSil factory @silicon
	sensor facLead factory @lead
	jump CheckSilicon lessThan facSil facLead
	jump CheckLead always
	
CheckCrawler:
	set stockLevel 20
	sensor facSil factory @silicon
	sensor facCoal factory @coal
	jump CheckSilicon lessThan facSil facCoal
	jump CheckCoal always
	
CheckNova:
	sensor facSil factory @silicon
	sensor facLead factory @lead
	sensor facTit factory @titanium
	op div silLevel facSil 60
	op div leadLevel facLead 40
	op div titLevel facTit 40
	
	FindMin:
		jump MinSil lessThan silLevel leadLevel
		jump MinLead always
	MinSil:
		set stockLevel 60
		jump CheckSilicon lessThan silLevel titLevel
	MinLead:
		set stockLevel 40
		jump CheckLead lessThan leadLevel titLevel
		jump CheckTitanium always
	
CheckSilicon:
	op sub needed stockLevel facSil
	set material @silicon
	jump CheckStock always
	
CheckLead:
	op sub needed stockLevel facLead
	set material @lead
	jump CheckStock always

CheckCoal:
	op sub needed stockLevel facCoal
	set material @coal 
	jump CheckStock always

CheckTitanium:
	op sub needed stockLevel facTit
	set material @titanium

CheckStock:
	jump NothingToDo equal needed 0
	sensor sourceStock source material
	op sub available sourceStock sourceMin
	jump NothingToDo lessThanEq available 0
	op min amount available needed
	jump FeedFactory greaterThan amount 0	

NothingToDo:
	set amount 0
	set material null
	jump Start always

###########################################
FeedFactory:
###########################################
CheckMule:
	jump FindMule equal mule null
	sensor muleDead mule @dead
	jump FindMule equal muleDead true

	sensor muleFlag mule @flag
	jump StartRun equal muleFlag procId
	jump FindMule notEqual muleFlag 0
	set @unit mule
	ucontrol flag procId
	jump StartRun always
	
FindMule:
	ubind unitType
	jump Start equal @unit null
	sensor unitDead @unit @dead
	jump FindMule equal unitDead true

	sensor unitFlag @unit @flag
	jump UseMule equal unitFlag procId

FlagMule:
	jump FindMule notEqual unitFlag 0
	ucontrol flag procId

UseMule:
	set mule @unit
	
StartRun:
	sensor carried mule @totalItems
	jump Pickup equal carried 0
	sensor carriedMat mule @firstItem
	jump Pickup equal carriedMat material
	
DumpUnneeded:
	ucontrol itemDrop @air carried
	
Pickup:
	ucontrol within sourceX sourceY dropRange isNearSource
	jump PickupLoop equal isNearSource true
	ucontrol approach sourceX sourceY dropRange
	jump Pickup always

	PickupLoop:
		op min amount amount cap
		set pickupI 0
		LoopUntilFull:
			ucontrol itemTake source material amount
			op add pickupI pickupI 1
			sensor carried mule @totalItems 
			jump FinishRun greaterThanEq pickupI 100
			jump LoopUntilFull lessThan carried amount

Deliver:
	ucontrol within factoryX factoryY dropRange isNearFactory
	jump DeliverLoop equal isNearFactory true
	ucontrol approach factoryX factoryY dropRange
	jump Deliver always

	DeliverLoop:
		set deliverI 0
		LoopUntilEmpty:
			ucontrol itemDrop factory carried
			sensor carried mule @totalItems
			jump FinishRun equal carried 0
			op add deliverI deliverI 1
			jump LoopUntilEmpty lessThan deliverI 100
	
FinishRun:
	jump Start always