set name "Limit Training"

Initialize:
	set maxUnits 4

	GetLinks:
		jump GetLinks lessThan @links 1
	
		set i 0
		set tier 0
		LinkLoop:
			getlink link i
			sensor type link @type
	
			#factory
			jump FoundFactory equal type @air-factory
			jump FoundFactory equal type @ground-factory
			jump FoundFactory equal type @naval-factory
	
			#reconstructor
			jump FoundT2 equal type @additive-reconstructor
			jump FoundT3 equal type @multiplicative-reconstructor
			jump FoundT4 equal type @exponential-reconstructor
			jump FoundT5 equal type @tetrative-reconstructor
			jump NextLink always
	
			FoundFactory:
				set factory link
				jump NextLink always
			FoundT2:
				jump NextLink greaterThan tier 1
				set tier 1
				jump NextLink always
			FoundT3:
				jump NextLink greaterThan tier 2
				set tier 2
				jump NextLink always
			FoundT4:
				jump NextLink greaterThan tier 3
				set tier 3
				jump NextLink always
			FoundT5:
				set tier 4
	
			NextLink:
				op add i i 1
				jump LinkLoop lessThan i @links
	
			jump GetLinks equal factory null
	
		EndGetLinks:

	op sub unitHolders @links 1
	op sub checkLinksAt maxUnits unitHolders
	set unitCount 0
	set totalCount 0

Start:	
	sensor baseType factory @config
	sensor baseId baseType @id
	op add id baseId tier
	lookup unit unitType id

Bind:
	ubind unitType
	jump CheckBuildings equal @unit null
	sensor isDead @unit @dead
	jump Start equal isDead true

	jump FinishCount equal firstUnit @unit
	jump Count notEqual firstUnit null
	set firstUnit @unit
	
Count:
	op add unitCount unitCount 1
	jump Start lessThan unitCount checkLinksAt
	
CheckBuildings:
	set i 0
	set builtUnits 0

	BuildingLoop:
		getlink building i
		sensor payloadCount building @payloadCount
		jump NextBuilding equal payloadCount 0
		sensor payloadType building @payloadType
		sensor payloadId payloadType @id
		
		CheckType:
			jump NextBuilding greaterThan payloadId id
			jump NextBuilding lessThan payloadId baseId

		AddBuiltUnit:
			op add builtUnits builtUnits payloadCount

		NextBuilding:
			op add i i 1
			jump BuildingLoop lessThan i @links

	FinishBuildingLoop:
		op add totalCount unitCount builtUnits
		jump Start lessThan totalCount maxUnits

MaxReached:
	# Setting the config to null or 0 does not clear it,
	# but using a t2 unit does
	control enabled factory false

FinishCount:
	op add totalCount unitCount builtUnits
	set lastCount totalCount
	set unitCount 0
	set firstUnit null
	set builtUnits 0
	jump Start greaterThanEq totalCount maxUnits
	control enabled factory true
	control config factory baseType
	jump Start always



	


