set name "Limit Training"

Initialize:
	set maxUnits 8
	set unitType @mega
	set unitCount 0
	set totalCount 0

GetStaticLinks:
	set factory factory1
	jump GetStaticLinks equal factory null

	sensor id unitType @id
	op mod tier id 5
	op sub baseId id tier
	lookup unit baseType baseId

Start:	
	op sub unitHolders @links 1
	op sub checkLinksAt maxUnits unitHolders

Bind:
	ubind unitType
	jump CheckLinks equal @unit null
	sensor isDead @unit @dead
	jump Start equal isDead true

	jump FinishCount equal firstUnit @unit
	jump Count notEqual firstUnit null
	set firstUnit @unit
	
Count:
	op add unitCount unitCount 1
	jump Start lessThan unitCount checkLinksAt
	
CheckLinks:
	set i 0
	set builtUnits 0

	LinkLoop:
		getlink building i
		sensor payloadCount building @payloadCount
		jump NextLink equal payloadCount 0
		sensor payloadType building @payloadType
		sensor payloadId payloadType @id
		
		CheckType:
			jump NextLink greaterThan payloadId id
			jump NextLink lessThan payloadId baseId

		AddBuiltUnit:
			op add builtUnits builtUnits payloadCount

		NextLink:
			op add i i 1
			jump LinkLoop lessThan i @links

	FinishLinkLoop:
		op add totalCount unitCount builtUnits
		jump Start lessThan totalCount maxUnits

MaxReached:
	# Setting the config to null or 0 does not clear it,
	# but using a t2 unit does
	control config factory @poly

FinishCount:
	op add totalCount unitCount builtUnits
	set lastCount totalCount
	set unitCount 0
	set firstUnit null
	set builtUnits 0
	jump Start greaterThanEq totalCount maxUnits
	control config factory baseType
	jump Start always



	


