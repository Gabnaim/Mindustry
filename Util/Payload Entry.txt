Initialize:
	set maxUnits 4
	set unitType @zenith
	set radius 5

	op shl procId @thisx 10 # first 10 bit for x
	op add procId procId @thisy # second 10 bit for y

	set STARTING 0
	set MOVING 1
	set ARRIVED 2
	set status STARTING

GetLinks:
	GetEntry:
		set entry conveyor1
		jump GetEntry equal entry null
	GetSwitch:
		set switch switch1
		jump GetSwitch equal switch null

	sensor moveX entry @x
	sensor moveY entry @y


Start:
CheckActive:
	sensor active switch @enabled
	jump Reset equal active false

	print "Status: "
	print status
	print "\n"

	jump Start equal status ARRIVED
	jump Proceed equal status MOVING
	
StartMove:
	print "Starting move\n"
	set i 0
	set firstUnit null

	MoveLoop:
		Bind:
			ubind unitType
			jump Start equal @unit null
			sensor isDead @unit @dead
			jump MoveLoop equal isDead true

			jump FinishMoveGroup equal firstUnit @unit
			jump FinishMoveGroup greaterThanEq i maxUnits
			jump ProcessMove notEqual firstUnit null
			set firstUnit @unit
		
		ProcessMove:
			sensor flag @unit @flag
			jump MoveLoop notEqual flag 0
			print "Moving\n"

			ucontrol flag procId
			op add i i 1
			ucontrol approach moveX moveY radius
			wait 1
			jump MoveLoop lessThan i maxUnits
		
		FinishMoveGroup:
			set totalFlagged i
			set firstUnit null
			set status MOVING
			jump Start always

Proceed:
	print "Proceeding\n"
	set firstUnit null
	set j 0

	ProceedLoop:
		Bind:
			ubind unitType
			jump Start equal @unit null
			sensor isDead @unit @dead
			jump ProceedLoop equal isDead true
		
		Navigate:
			sensor flag @unit @flag
			jump ProceedLoop notEqual flag procId
			print "Navigating\n"

			ucontrol within moveX moveY radius isNear
			jump ProceedLoop equal isNear false

			ucontrol move moveX moveY
			op add j j 1
			print "Moving to entry\n"
			wait 1
			ucontrol payEnter
			ucontrol stop
			ucontrol flag 0
			ucontrol unbind
			

			jump ProceedLoop lessThan j totalFlagged

FinishRun:
	set status ARRIVED
	print "\nFlagged: "
	print totalFlagged
	printflush message1
	jump Start always
	
Reset:
	set status STARTING
	printflush message1
	jump Start always
	
	

