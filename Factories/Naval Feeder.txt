Initialize:
	set unitType @flare
	op shl procId @thisx 10
	op add procId procId @thisy
	set maxTick 600 #release mule after 10 seconds idle
	set sourceMin 500
	set dropRange 1

	GetLinks:
		set factory factory1
		jump GetLinks equal factory null
	
	sensor factoryX factory @x
	sensor factoryY factory @y
	
	GetStartInfo:
		ubind unitType
		jump GetStartInfo equal @unit null
		sensor cap @unit @itemCapacity
		sensor range @unit @range
		ulocate building core false 0 sourceX sourceY sourceFound source

Start:
	printflush message1
###########################################	
CheckFactory:
###########################################
	sensor buildType factory @config
	jump CheckRisso equal buildType @risso
	jump CheckRetusa equal buildType @retusa
	jump Start always
	
CheckRisso:	
	sensor facSil factory @silicon
	sensor facGlass factory @metaglass
	set stockLevel 40
	jump CheckSilicon lessThan facSil facGlass
	set stockLevel 70
	jump CheckGlass always
	
CheckRetusa:
	sensor facSil factory @silicon
	sensor facGlass factory @metaglass
	sensor facTit factory @titanium
	op div silLevel facSil 30
	op div glassLevel facGlass 50
	op div titLevel facTit 40
	
	FindMin:
		jump MinSil lessThan silLevel glassLevel
		jump MinGlass always
	MinSil:
		set stockLevel 60
		jump CheckSilicon lessThan silLevel titLevel
	MinGlass:
		set stockLevel 40
		jump CheckGlass lessThan glassLevel titLevel
		jump CheckTitanium always
	
CheckSilicon:
	op sub needed stockLevel facSil
	set material @silicon
	jump CheckStock greaterThan needed 0
	
CheckGlass:
	op sub needed stockLevel facGlass
	set material @metaglass
	jump CheckStock greaterThan needed 0

CheckTitanium:
	op sub needed stockLevel facTit
	set material @titanium
	jump NothingToDo equal needed 0

CheckStock:
	sensor sourceStock source material
	op sub available sourceStock sourceMin
	jump NothingToDo lessThanEq available 0
	op min amount available needed
	jump FeedFactory greaterThan amount 0	

NothingToDo:
	set amount 0
	set material null
	jump Start always

###########################################
FeedFactory:
###########################################
CheckMule:
	jump FindMule equal mule null
	sensor muleDead mule @dead
	jump StartRun equal muleDead false
	
FindMule:
	ubind unitType
	jump Start equal @unit null
	sensor unitDead @unit @dead
	jump FindMule equal unitDead true
	sensor unitFlag @unit @flag
	jump GrabMule equal unitFlag procId
	jump FindMule notEqual unitFlag 0
	ucontrol flag procId

GrabMule:
	set mule @unit
	
StartRun:
	ucontrol approach sourceX sourceY dropRange
	
DropUnneeded:
	sensor carried mule @totalItems
	jump Pickup equal carried 0
	jump Pickup equal carried null
	sensor carriedMat mule @firstItem
	jump Pickup equal carriedMat material
	set unneededI 0

	DropUnneededTilEmpty:
		ucontrol itemDrop source carried
		sensor carried mule @totalItems
		jump Pickup equal carried 0
		op add unneededI unneededI 1
		jump DropUnneededTilEmpty lessThan unneededI 100

Pickup:
	set startTick @tick
	op min amount amount cap
	set pickupI 0
	LoopUntilFull:
		ucontrol itemTake source material amount
		op add pickupI pickupI 1
		sensor carried mule @totalItems 
		jump FinishRun greaterThanEq pickupI 100
		jump LoopUntilFull lessThan carried amount
	
Deliver:
	ucontrol approach factoryX factoryY dropRange
	set deliverI 0
	LoopUntilEmpty:
		ucontrol itemDrop factory carried
		sensor carried mule @totalItems
		jump FinishRun equal carried 0
		op add deliverI deliverI 1
		jump LoopUntilEmpty lessThan deliverI 100

FinishRun:
	jump Start always
	#jump Start equal mule null
	op sub elapsed @tick startTick
	jump Start lessThan elapsed maxTick

ReleaseMule:
	ucontrol flag 0
	ucontrol approach sourceX sourceY 5
	set mule null
	jump Start always
	


