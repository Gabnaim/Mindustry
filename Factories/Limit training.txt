Initialize:
	set maxUnits 8
	set unitType @mono
	set baseType @mono
	set t2Type @poly
	set t3type @mega

GetStaticLinks:
	set factory factory1
	jump GetStaticLinks equal factory null

	# We should also count units in the conveyors and
	# reconstructors. Take off 1 for the factory
	op sub unitHolders @links 1
	op sub checkLinksAt maxUnits unitHolders

Start:	
Bind:
	ubind unitType
	jump Start equal @unit null
	sensor isDead @unit @dead
	jump Start equal isDead true

	jump FinishCount equal firstUnit @unit
	jump Count notEqual firstUnit null
	set firstUnit @unit
	
Count:
	op add unitCount unitCount 1
	jump Start lessThan unitCount checkLinksAt
	
CheckLinks:
	set i 0
	set builtUnits 0

	LinkLoop:
		getlink building i
		sensor unitsBuilt building @payloadCount
		jump NextLink equal unitsBuilt 0
		sensor payloadType building @payloadType
		
		CheckType:
			jump AddBuiltUnit equal payloadType baseType
			jump AddBuiltUnit equal payloadType t2Type
			jump AddBuiltUnit equal payloadType t3Type
			jump NextLink always

		AddBuiltUnit:
			op add builtUnits builtUnits unitsBuilt

		NextLink:
			op add i i 1
			jump LinkLoop lessThan i @links

	FinishLinkLoop:
		op add totalCount unitCount builtUnits
		jump Start lessThan totalCount maxUnits

MaxReached:
	# Setting the config to null or 0 does not clear it,
	# but using a t2 unit does
	control config factory t2Type

FinishCount:
	op add totalCount unitCount builtUnits
	set lastCount totalCount
	set unitCount 0
	set firstUnit null
	set builtUnits 0
	jump Start greaterThanEq totalCount maxUnits
	control config factory baseType
	jump Start always



	


