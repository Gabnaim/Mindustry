Initialize:
	set unitType @poly
	set miningRange 7
	set minedOre @scrap

	set dropToCore false
	set useFlagger true

	set maxTick 360 #break loop after 6 seconds idle

	GetSwitch:
		set switch switch1
		jump GetSwitch equal switch null

	GetStartInfo:
		ubind unitType
		jump GetStartInfo equal @unit null
		sensor cap @unit @itemCapacity
		ulocate building core false 0 coreX coreY coreFound core

	jump GetDropTarget equal dropToCore false
	set dropTarget core
	jump GetDropCoords always

	GetDropTarget:
		set l 0
		LinkLoop:
			getlink link l
			sensor type link @type
			jump Found equal link core
			jump Found equal type @container
			jump Found equal type @vault
		NextLink:
			op add l l 1
			jump LinkLoop lessThan l @links
		NotFound:
			jump GetDropTarget always
		Found:
			set dropTarget link
	
	GetDropCoords:
		sensor dropX dropTarget @x
		sensor dropY dropTarget @y

	GetId:
		op shl procId @thisx 10
		op add procId procId @thisy
	
		jump UseUnflagged equal useFlagger false
		UseFlagged:
			set usedFlag procId
			jump Start always
	
		UseUnflagged:
			set usedFlag 0
	
Start:
	printflush message1
CheckActive:
	sensor active switch @enabled
	jump Reset equal active false
	set isStopped false

BindUnit:
	ubind unitType
	jump Start equal @unit null
	sensor isDead @unit @dead
	jump Start equal isDead true
	sensor flag @unit @flag
	jump Start notEqual flag usedFlag

SelectAction:
	jump FindOre equal oreFound false
	sensor isMining @unit @mining
	sensor carried @unit @totalItems
	sensor carriedItem @unit @firstItem

	jump Mine equal carried 0
	jump DumpUnneeded notEqual carriedItem minedOre
	jump DropItems equal carried cap
	jump Mine always

DumpUnneeded:
	ucontrol itemDrop @air carried
	jump Start always

DropItems:
	ucontrol within dropX dropY miningRange isNearDrop
	jump DropLoop equal isNearDrop true
	ucontrol boost true
	ucontrol approach dropX dropY miningRange
	jump Start always

	DropLoop:
		set startTick @tick
		ucontrol boost false
		sensor carried @unit @totalItems
		LoopUntilEmpty:
			ucontrol itemDrop dropTarget carried
			sensor carried @unit @totalItems
			jump Mine equal carried 0

			# break loop if idling too long
			op sub elapsed @tick startTick
			jump Start greaterThan elapsed maxTick
			jump LoopUntilEmpty greaterThan carried 0 
	jump Start always

Mine:
	MoveToOre:
		ucontrol within oreX oreY miningRange isNearMine
		jump MineOre equal isNearMine true
		ucontrol approach oreX oreY miningRange
	
	MineOre:
		ucontrol mine oreX oreY
		jump Start always

FindOre:
	# Use this unit to find the nearest ore source
	GoToDrop:
		ucontrol within dropX dropY 1 isNearDrop
		jump LocateOre equal isNearDrop true
		ucontrol approach dropX dropY 1
		jump GoToDrop always
	
	LocateOre:
		ulocate ore core true minedOre oreX oreY oreFound oreMine
		jump Start equal oreFound true

	NoOre:
		print "No "
		print minedOre
		print " was found on the map"
		printflush message1
		stop

Reset:
	jump Start equal isStopped true

	set firstUnit null
	StopLoop:
		ubind unitType
		jump AllStopped equal @unit firstUnit
		sensor flag @unit @flag
		jump StopLoop notEqual flag usedFlag

		jump ReleaseUnit notEqual firstUnit null
		set firstUnit @unit
		
		ReleaseUnit:
			ucontrol stop
			ucontrol unbind
		jump StopLoop always
		
	AllStopped:
		set isStopped true
		set firstUnit null
		set oreFound false
		jump Start always
	
