set name "Mule Flagger"

Initialize:
	set unitType @flare
	set switch switch1
	set status "INITIALIZE"
	jump Initialize equal switch null
	set releaseWaitSecs 5
	set error " "

	op shl procId @thisx 9
	op add procId procId @thisy
	op mul releaseWaitMs releaseWaitSecs 1000

	op add nearX @thisx 1
	op add nearY @thisy 1
	op add farX @thisx 15
	op add farY @thisy 15

	set releaseStart @time

Start:
	sensor active switch @enabled
	jump Reset equal active false

CheckMule:
	jump FindMule equal mule null
	sensor muleDead mule @dead
	jump FindMule equal muleDead true

	sensor muleFlag mule @flag
	jump StartRun equal muleFlag procId
	jump FindMule notEqual muleFlag procId
	ubind mule
	jump StartRun always

FindMule:
	set firstUnit null
	set free 0
	set minDistance 1000
	set status "FIND"

	FindLoop:
		ubind unitType
		jump NotFound equal @unit null
		sensor unitDead @unit @dead
		jump FindLoop equal unitDead true
	
		jump FinishCount equal firstUnit @unit
		jump FlagProcess notEqual firstUnit null
		set firstUnit @unit
	
	FlagProcess:
		sensor flag @unit @flag
		jump UseMule equal flag procId
		jump FindLoop notEqual flag 0
	
	CheckDistance:
		ucontrol stop
		sensor x @unit @x
		sensor y @unit @y
		op sub xDiff @thisx x
		op sub yDiff @thisy y
		op len distance xDiff yDiff
		jump CountFree equal status "FIND"
		GetClosest:
			op sub diff distance minDistance
			op abs diff diff
			jump FlagMule lessThan diff 3
			jump FindLoop always
		
		CountFree:
			op add free free 1
			jump FindLoop greaterThan distance minDistance
			set minDistance distance
			jump FindLoop always
	
	FinishCount:
		jump NotFound equal free 0
		set error " "
		set firstUnit null
		jump FindMule equal status "FLAG"
		set status "FLAG"
		jump FindLoop always
	
	NotFound:
		set error "No free units"
		jump FindMule always
	
	FlagMule:
		ucontrol flag procId
	
	UseMule:
		set mule @unit
	
	FindDone:
		set error " "

StartRun:
	set releaseStart @time
	jump MoveFar equal status "MOVEFAR"

	MoveNear:
		ucontrol within nearX nearY 3 isNear
		jump MoveFar equal isNear true
		ucontrol approach nearX nearY 3
		set status "MOVENEAR"
		jump Next always

	MoveFar:
		ucontrol within farX farY 3 isFar
		jump MoveNear equal isFar true
		ucontrol approach farX farY 3
		set status "MOVEFAR"
		jump Next always

	Next:
		jump Start always

Reset:
	jump Start equal mule null
	op sub releaseWait @time releaseStart
	jump Start lessThan releaseWait releaseWaitMs

Release:
	set status "RELEASE"
	
	ReleaseUnit:
		ucontrol stop
		ucontrol flag 0
		ucontrol boost false
		ucontrol unbind
		set mule null
		set status "IDLE"
		set releaseStart @time
		jump Start always