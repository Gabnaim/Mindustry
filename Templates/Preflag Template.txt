Initialize:
	set status "INITIALIZE"
	set unitType @poly
	set maxUnits 4 # store upto 8

	GetSorter:
		set sorter sorter1
		jump GetSorter equal sorter null
	
	GetId:
		op shl procId @thisx 9
		op add procId procId @thisy

	set totalFlagged 0
	set totalFree 0
	set totalUnits 0
	set firstUnit null
	set flagged 0
	set free 0
	set i 0
	
Preflag:
	set status "COUNT"

	PreflagLoop:
	BindUnit:
		ubind unitType
		jump Preflag equal @unit null
		sensor isDead @unit @dead
		jump BindUnit equal isDead true

		jump FinishCount equal firstUnit @unit
		jump FlagProcess notEqual firstUnit null
		set firstUnit @unit

	FlagProcess:
		sensor flag @unit @flag
		op shr unitProcId flag extraBits
		jump CountFlagged equal unitProcId procId
		jump CountFree equal flag 0
		jump NextCount always
		
	CountFlagged:
		op add flagged flagged 1
		jump NextCount notEqual status "UNFLAG"
		Unflag:
			ucontrol flag 0
			op sub neededFlags neededFlags 1
			jump FlagDone equal neededFlags 0
			jump NextCount always

	CountFree:
		op add free free 1
		jump NextCount notEqual status "FLAG"
		Flag:
			ucontrol flag procId
			op sub neededFlags neededFlags 1
			jump FlagDone equal neededFlags 0
	
	NextCount:
		op add i i 1
		jump PreflagLoop always

	FinishCount:
		jump GetNextAction greaterThan totalUnits 0
		set totalFlagged flagged
		set totalFree free
		set totalUnits i

		GetNextAction:
			jump FlagDone equal totalFlagged maxUnits
			jump FlagDone equal status "FLAG"
			jump FlagDone equal status "UNFLAG"

			set flagged 0
			set free 0
			set i 0

			jump NeedFlags lessThan totalFlagged maxUnits
			NeedUnflags: 
				op sub neededFlags totalFlagged maxUnits
				set status "UNFLAG"
				jump PreflagLoop always

			NeedFlags:
				op sub neededFlags maxUnits totalFlagged
				op min neededFlags neededFlags totalFree
				jump FlagDone lessThanEq neededFlags 0
				set status "FLAG"
				jump PreflagLoop always

	FlagDone:

	GetStartUnit:
		# get an already flagged unit
		ubind unitType
		jump GetStartUnit equal @unit null
		sensor isDead @unit @dead
		jump GetStartUnit equal isDead true

		sensor flag @unit @flag
		jump GetStartUnit notEqual flag procId

		ucontrol approach @thisx @thisy 5

	set status "IDLE"
	set used 0

Start:
CheckActive:
	sensor oreChoice sorter @config
	op notEqual active oreChoice null
	jump ActiveChanged notEqual active lastActive
	jump Reset equal active false

	jump FinishGroup greaterThanEq used maxUnits

BindUnit:
	ubind unitType
	jump Start equal @unit null
	jump FinishGroup equal firstUnit @unit
	jump ProcessUnit notEqual firstUnit null
	set firstUnit @unit
	
ProcessUnit:
	sensor isDead @unit @dead
	jump BindUnit equal isDead true

	sensor flag @unit @flag
	jump BindUnit notEqual flag procId

DoStuff:
	set status "PROCESSING"
	op add used used 1
	ucontrol within @thisx @thisy 10 isNear
	jump Move equal isNear true
	ucontrol approach @thisx @thisy 5
	jump Next always

	Move:
		sensor x @unit @x
		sensor y @unit @y
		op add moveX x 12
		op add moveY y 12
		ucontrol move moveX moveY

Next:
	jump Start always

FinishGroup:
	set totalUsed used
	set used 0
	set firstUnit null
	jump Start always

ActiveChanged:
	set lastActive active
	jump Reset equal active false
	jump Initialize always

Reset:
	jump Start equal status "IDLE"
	set status "STOPPING"

	set firstUnit null
	StopLoop:
		ubind unitType
		jump AllStopped equal @unit firstUnit

		jump StopProcess notEqual firstUnit null
		set firstUnit @unit

		StopProcess:
			sensor flag @unit @flag
			jump StopLoop notEqual flag procId
			ucontrol stop
			ucontrol itemDrop @air 200
			ucontrol unbind

		jump StopLoop always
		
	AllStopped:
		set status "IDLE"
		jump Start always
	




	